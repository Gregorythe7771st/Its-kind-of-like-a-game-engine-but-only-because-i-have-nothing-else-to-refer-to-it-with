<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Raycaster</title>
    <style>
        body {
            background-color: #555555;
            margin: 0;
            overflow: hidden;
        }
        canvas {
            position: fixed;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: black;
        }
        
        #vision {
            position: fixed;
            top: 52%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        #U {
            position: fixed;
            top:68%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            user-select: none;
            touch-action: manipulation;
        }
        
        #D {
            position: fixed;
            top: 78%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            user-select: none;
            touch-action: manipulation;
        }
        
        #R {
            position: fixed;
            top: 71%;
            left: 30%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            user-select: none;
            touch-action: manipulation;
        }
        
        #L {
            position: fixed;
            top: 71%;
            left: 70%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            user-select: none;
            touch-action: manipulation;
        }
        
        #RL {
            position: fixed;
            top: 90%;
            left: 40%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            user-select: none;
            touch-action: manipulation;
        }
        
        #RR {
            position: fixed;
            top: 90%;
            left: 60%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            user-select: none;
            touch-action: manipulation;
        }
        
    </style>
</head>
<body>
<canvas id="canvas" width="500px" height="500px"></canvas>
<canvas id="vision" width="500px" height="75px"></canvas>
<button id="U">Forward</button>
<button id="D">Backward</button>
<button id="L">Right</button>
<button id="R">Left</button>
<button id="RL">Rotate Left</button>
<button id="RR">Rotate Right</button>
<script>
let x = 250;
let y = 200;
let rotation = 0;
let pixel = 0
const vision = document.getElementById("vision")
const vctx = vision.getContext("2d")
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let map = [1,1,1,1,1,1,1,1,1,1,
           1,0,0,0,0,0,0,0,0,1,
           1,0,0,0,0,0,0,0,0,2,
           1,1,1,0,0,0,0,1,0,2 ,
           1,0,0,0,0,0,0,1,0,1,
           1,0,1,0,1,0,1,0,0,1,
           1,0,1,0,0,0,0,0,0,1,
           1,0,1,1,0,0,0,2,0,1,
           1,0,0,0,1,0,0,0,0,2,
           1,1,1,1,1,1,1,1,2,2]

let up = false;
let down = false;
let left = false;
let right = false;
let rotateR = false;
let rotateL = false;
 
document.addEventListener('keydown', function(event) {
    if (event.keyCode === 87) {
        up = true;
    }
});

document.addEventListener('keyup', function(event) {
    if (event.keyCode === 87) {
        up = false;
    }
});

document.addEventListener('keydown', function(event) {
    if (event.keyCode === 83) {
        down = true;
    }
});

document.addEventListener('keyup', function(event) {
    if (event.keyCode === 83) {
        down = false;
    }
});

document.addEventListener('keydown', function(event) {
    if (event.keyCode === 65) {
        left = true;
    }
});

document.addEventListener('keyup', function(event) {
    if (event.keyCode === 65) {
        left = false;
    }
});

document.addEventListener('keydown', function(event) {
    if (event.keyCode === 68) {
        right = true;
    }
});

document.addEventListener('keyup', function(event) {
    if (event.keyCode === 68) {
        right = false;
    }
});

document.addEventListener('keydown', function(event) {
    if (event.keyCode === 37) {
        rotateL = true;
    }
});

document.addEventListener('keyup', function(event) {
    if (event.keyCode === 37) {
        rotateL = false;
    }
});

document.addEventListener('keydown', function(event) {
    if (event.keyCode === 39) {
        rotateR = true;
    }
});

document.addEventListener('keyup', function(event) {
    if (event.keyCode === 39) {
        rotateR = false;
    }
});

let buttonR = document.getElementById("R")
let buttonL = document.getElementById("L")
let buttonF = document.getElementById("U")
let buttonB = document.getElementById("D")
let buttonRL = document.getElementById("RL")
let buttonRR = document.getElementById("RR")
    
    buttonL.ontouchstart = function() {
        left = true
        this.style.backgroundColor = "#555"
    }
    buttonL.ontouchend = function() {
        left = false
        this.style.backgroundColor = ""
    }

    buttonR.ontouchstart = function() {
        right = true
        this.style.backgroundColor = "#555"
    }
    buttonR.ontouchend = function() {
        right = false
        this.style.backgroundColor = ""
    }

    buttonF.ontouchstart = function() {
        up = true
        this.style.backgroundColor = "#555"
    }
    buttonF.ontouchend = function() {
        up = false
        this.style.backgroundColor = ""
    }

    buttonB.ontouchstart = function() {
        down = true
        this.style.backgroundColor = "#555"
    }
    buttonB.ontouchend = function() {
        down = false
        this.style.backgroundColor = ""
    }
    
    buttonRL.ontouchstart = function() {
        rotateL = true
        this.style.backgroundColor = "#555"
    }
    buttonRL.ontouchend = function() {
        rotateL = false
        this.style.backgroundColor = ""
    }

    buttonRR.ontouchstart = function() {
        rotateR = true
        this.style.backgroundColor = "#555"
    }
    buttonRR.ontouchend = function() {
        rotateR = false
        this.style.backgroundColor = ""
    }


function drawSquare() {
    ctx.fillStyle = "red";
    ctx.fillRect(x, y, 25, 25);
}

function clearSquare() {
    ctx.fillStyle = "black";
    ctx.fillRect(x, y, 25, 25);
}

function move() {
    clearSquare();
    clearRays();
    clearVision();

    // Adjusting movement based on rotation angle
    const angleRad = rotation * Math.PI / 180;
    const moveX = Math.cos(angleRad);
    const moveY = Math.sin(angleRad);

    if(up) {
        x += moveX;
        y += moveY;
    }
    
    if(down) {
        x -= moveX;
        y -= moveY;
    }
    
    if(left) {
        x -= moveY;
        y += moveX;
    }
    
    if(right) {
        x += moveY;
        y -= moveX;
    }
    
    if(rotateL) {
        rotation--;
    }
    
    if(rotateR) {
        rotation++;
    }
    
    pixel = 0;
    drawSquare();
    castRays();
    setTimeout(move, 4);    
}

function renderMap(){
    for(let i = 0; i < map.length; i++) {
        const row = Math.floor(i / 10);
        const col = i % 10;

        if(map[i] === 1) {
            ctx.fillStyle = "white";
            ctx.fillRect(col * 50, row * 50, 50, 50);
        } else if(map[i] === 2) {
            ctx.fillStyle = "green";
            ctx.fillRect(col * 50, row * 50, 50, 50);
        }
    }
}

function hasCollision(startX, startY, endX, endY) {
    const tileWidth = 50; // Assuming each tile in the map is 50x50 pixels

    // Calculate the row and column of the start and end points
    const startRow = Math.floor(startY / tileWidth);
    const startCol = Math.floor(startX / tileWidth);
    const endRow = Math.floor(endY / tileWidth);
    const endCol = Math.floor(endX / tileWidth);

    // Check if the ray intersects with any walls
    for (let row = Math.min(startRow, endRow); row <= Math.max(startRow, endRow); row++) {
        for (let col = Math.min(startCol, endCol); col <= Math.max(startCol, endCol); col++) {
            if (map[row * 10 + col] === 1 || map[row * 10 + col] === 2) {
                return true; // Collision detected
                                
            }
        }
    }

    return false; // No collision
}

function findCollisionPoint(startX, startY, endX, endY, angle) {
    const tileWidth = 50;

    let collisionX = startX;
    let collisionY = startY;

    // Calculate the direction of the ray
    const dx = endX - startX;
    const dy = endY - startY;

    // Calculate the length of the ray
    const rayLength = Math.sqrt(dx * dx + dy * dy);

    // Normalize the direction vector
    const stepX = dx / rayLength;
    const stepY = dy / rayLength;

    // Incrementally check each position along the ray until collision is found
    let posX = startX;
    let posY = startY;
    while (posX !== endX || posY !== endY) {
        posX += stepX;
        posY += stepY;

        const col = Math.floor(posX / tileWidth);
        const row = Math.floor(posY / tileWidth);

        if (map[row * 10 + col] === 1) {
    // Collision detected
    collisionX = posX;
    collisionY = posY;

    let distance = Math.sqrt((collisionX - startX) ** 2 + ((collisionY - startY) ** 2))        
    
    
    let brightness = 3600 / distance ** 2 * 255                
    
    vctx.fillStyle = "rgb(" + Math.floor(brightness) + ", 0, 0)"
    vctx.fillRect(pixel, 0, 2, 75)       
    
    break;
       }else if(map[row * 10 + col] === 2) {
           // Collision detected
    collisionX = posX;
    collisionY = posY;

    let distance = Math.sqrt((collisionX - startX) ** 2 + ((collisionY - startY) ** 2))        
    
    
    let brightness = 3600 / distance ** 2 * 255                   
    
    vctx.fillStyle = "rgb(0, " + Math.floor(brightness) + ", 0)"
    vctx.fillRect(pixel, 0, 2, 75);

    break;
       }
}

    return { x: collisionX, y: collisionY };
}


function castRays() {
    const maxRayLength = 600;
    const numRays = 1000;
    const angleStep = 360 / numRays;

    for (let angle = -30 + rotation; angle < 60 + rotation; angle += angleStep) {
        let endX = x + Math.cos(angle * Math.PI / 180) * maxRayLength;
        let endY = y + Math.sin(angle * Math.PI / 180) * maxRayLength;

        if (hasCollision(x + 12.5, y + 12.5, endX, endY)) {
            // If collision detected, adjust end point to collision point
            const collisionPoint = findCollisionPoint(x + 12.5, y + 12.5, endX, endY, angle); endX = collisionPoint.x; endY = collisionPoint.y; }ctx.beginPath();
    ctx.moveTo(x + 12.5, y + 12.5);
    ctx.lineTo(endX, endY);
    ctx.strokeStyle = 'blue';
    ctx.stroke();
    pixel += 2
     }
}

function clearRays(){

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    ctx.fillStyle = "black";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    renderMap();
}

function clearVision(){
    vctx.clearRect(0, 0, canvas.width, canvas.height)
}

renderMap();
castRays();
drawSquare();
move();
</script>
</body>
</html>
